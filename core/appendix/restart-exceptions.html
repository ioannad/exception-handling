
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Restarts for WebAssembly Exception Handling &#8212; WebAssembly 1.1</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"TeX": {"MAXBUFFER": 30720}})</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Index of Types" href="index-types.html" />
    <link rel="prev" title="Soundness" href="properties.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/webassembly.png" alt="Logo"/>
            </a></p><h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../syntax/index.html">Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../valid/index.html">Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../exec/index.html">Execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../binary/index.html">Binary Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../text/index.html">Text Format</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Appendix</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="embedding.html">Embedding</a></li>
<li class="toctree-l2"><a class="reference internal" href="implementation.html">Implementation Limitations</a></li>
<li class="toctree-l2"><a class="reference internal" href="algorithm.html">Validation Algorithm</a></li>
<li class="toctree-l2"><a class="reference internal" href="custom.html">Custom Sections</a></li>
<li class="toctree-l2"><a class="reference internal" href="properties.html">Soundness</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Restarts for WebAssembly Exception Handling</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index-types.html">Index of Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="index-instructions.html">Index of Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="index-rules.html">Index of Semantic Rules</a></li>
</ul>


<hr />
<ul>
    
    <li class="toctree-l1"><a href="../genindex.html">Index</a></li>
    
    <li class="toctree-l1"><a href="../_download/WebAssembly.pdf">Download as PDF</a></li>
    
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="restarts-for-webassembly-exception-handling">
<h1>Restarts for WebAssembly Exception Handling<a class="headerlink" href="#restarts-for-webassembly-exception-handling" title="Permalink to this headline">¶</a></h1>
<div class="section" id="or-handling-exceptions-from-a-distance-without-unwinding-the-stack">
<h2>Or, handling exceptions from a distance without unwinding the stack<a class="headerlink" href="#or-handling-exceptions-from-a-distance-without-unwinding-the-stack" title="Permalink to this headline">¶</a></h2>
<p>The instruction <span class="math notranslate nohighlight">\(\href{../appendix/restart-exceptions.html#syntax-try-handle}{\mathsf{try...handle}}\)</span> suggested by Manuel Simoni in his article What’s a condition system and why do you want one? <a class="footnote-reference brackets" href="#cite-simoni" id="id1">1</a>.
could be implemented as an extension to the current exception handling proposal
with the additions described here.</p>
<p>Simoni says, that to decouple a handler from unwinding the stack can be done with
<span class="math notranslate nohighlight">\(\href{../appendix/restart-exceptions.html#syntax-handle}{\mathsf{handle}}\)</span>, which, as we’ll see later, can enable a user to choose which handlers to
use without redefining a function (e.g. a library function).</p>
<blockquote>
<div><p>HANDLE is just like CATCH, except that the stack is not unwound when an Exception is thrown.</p>
</div></blockquote>
<p>From this we can already guess that we’ll have to modify or extend the execution rules for
<span class="math notranslate nohighlight">\(\href{../syntax/instructions.html#syntax-instr-control}{\mathsf{throw}}\)</span> in order to implement such a <span class="math notranslate nohighlight">\(\href{../appendix/restart-exceptions.html#syntax-try-handle}{\mathsf{try...handle}}\)</span> instruction.</p>
<p>Contents:</p>
<ol class="arabic simple">
<li><p>Additions to the formalism of Wasm-EH to implement two-phase unwinding.</p></li>
<li><p>Present Simoni’s <a class="reference internal" href="#examples"><span class="std std-ref">examples</span></a> rewritten in the extended WebAssembly-EH syntax presented here.
- Includes illustrations of the stack transformations which Simoni also shows, but for the unified Wasm stack.</p></li>
</ol>
</div>
<div class="section" id="additions-to-implement-exception-resumption">
<span id="resumption-additions"></span><h2>1. Additions to implement exception resumption<a class="headerlink" href="#additions-to-implement-exception-resumption" title="Permalink to this headline">¶</a></h2>
<p>In this possible extension of the current exception handling spec the following are added.</p>
<ul class="simple">
<li><p>A new primitive <span class="math notranslate nohighlight">\(\href{../appendix/restart-exceptions.html#syntax-try-handle}{\mathsf{try...handle}}\)</span> control instruction.</p></li>
<li><p>A new runtime stack administrative instruction <span class="math notranslate nohighlight">\(\href{../appendix/restart-exceptions.html#syntax-handle}{\mathsf{handle}}\)</span>.</p></li>
<li><p>Reduction step for the instruction <span class="math notranslate nohighlight">\(\href{../appendix/restart-exceptions.html#syntax-try-handle}{\mathsf{try...handle}}\)</span>.</p></li>
<li><p>Reduction step for the administrative instruction <span class="math notranslate nohighlight">\(\href{../appendix/restart-exceptions.html#syntax-handle}{\mathsf{handle}}\)</span>.</p></li>
<li><p>Additional reduction steps to <a class="reference internal" href="../exec/instructions.html#exec-throwaddr"><span class="std std-ref">Throwing an exception</span></a>,
checking the list of active handlers against an exception tag.</p>
<ul>
<li><p><em>WIP:</em> A list of “active handlers” added somewhere</p></li>
</ul>
</li>
</ul>
<p>In the following subsections these are defined more concretely.
See these new constructs in action in <a class="reference internal" href="#examples"><span class="std std-ref">the examples below</span></a>.</p>
<div class="section" id="syntax-for-new-control-instruction-tryhandle">
<span id="syntax-try-handle"></span><h3>Syntax for new control instruction <span class="math notranslate nohighlight">\(\href{../appendix/restart-exceptions.html#syntax-try-handle}{\mathsf{try...handle}}\)</span><a class="headerlink" href="#syntax-for-new-control-instruction-tryhandle" title="Permalink to this headline">¶</a></h3>
<div class="math notranslate nohighlight">
\[\def\mathdef1#1{{}}\mathdef1{instruction} \href{../syntax/instructions.html#syntax-instr}{\mathit{instr}} ::= \dots ~|~~ \href{../syntax/instructions.html#syntax-instr-control}{\mathsf{try}}~\href{../syntax/instructions.html#syntax-blocktype}{\mathit{blocktype}}~\href{../syntax/instructions.html#syntax-instr}{\mathit{instr}}^\ast~\href{../appendix/restart-exceptions.html#syntax-handle}{\mathsf{handle}}~\href{../syntax/modules.html#syntax-exnidx}{\mathit{exnidx}}~\href{../syntax/instructions.html#syntax-instr}{\mathit{instr}}^\ast~\href{../syntax/instructions.html#syntax-instr-control}{\mathsf{end}}\]</div>
<p>An exception whose index is used in a <span class="math notranslate nohighlight">\(\href{../appendix/restart-exceptions.html#syntax-handle}{\mathsf{handle}}\)</span> statement may be called a restart.
There probably isn’t any reason to extend exceptions to a more generalised concept
“restarts”.</p>
</div>
<div class="section" id="new-administrative-instruction-handle-on-the-runtime-stack">
<span id="syntax-handle"></span><h3>New administrative instruction <span class="math notranslate nohighlight">\(\href{../appendix/restart-exceptions.html#syntax-handle}{\mathsf{handle}}\)</span> on the runtime stack<a class="headerlink" href="#new-administrative-instruction-handle-on-the-runtime-stack" title="Permalink to this headline">¶</a></h3>
<p>A new runtime stack administrative instruction <span class="math notranslate nohighlight">\(\href{../appendix/restart-exceptions.html#syntax-handle}{\mathsf{handle}}\)</span>, is added to the <a class="reference internal" href="../exec/runtime.html#stack"><span class="std std-ref">stack</span></a>
to represent active exception handles.</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{llll}
\def\mathdef1#1{{}}\mathdef1{(handle)} &amp; \mathit{handle} &amp;::=&amp;
  \href{../appendix/restart-exceptions.html#syntax-handle}{\mathsf{handle}}_?\{\href{../syntax/modules.html#syntax-exnidx}{\mathit{exnidx}}~\href{../syntax/instructions.html#syntax-instr}{\mathit{instr}}^\ast\}\\
\end{array}\end{split}\]</div>
<p><em>(TODO: would administrative</em> <span class="math notranslate nohighlight">\(\href{../appendix/restart-exceptions.html#syntax-handle}{\mathsf{handle}}\)</span> <em>take an index like</em> <span class="math notranslate nohighlight">\(\href{../syntax/instructions.html#syntax-instr-control}{\mathsf{catch}}_m\)</span> <em>?)</em></p>
</div>
<div class="section" id="reduction-step-for-tryhandle">
<span id="exec-try-handle"></span><h3>Reduction step for <span class="math notranslate nohighlight">\(\href{../appendix/restart-exceptions.html#syntax-try-handle}{\mathsf{try...handle}}\)</span><a class="headerlink" href="#reduction-step-for-tryhandle" title="Permalink to this headline">¶</a></h3>
<div class="math notranslate nohighlight">
\[\begin{split}~\\[-1ex]
\begin{array}{c}
\hspace{-13ex} S; F; \href{../exec/runtime.html#syntax-val}{\mathit{val}}^n~(\href{../syntax/instructions.html#syntax-instr-control}{\mathsf{try}}~\mathit{bt}~\href{../syntax/instructions.html#syntax-instr}{\mathit{instr}}_1^\ast~\href{../appendix/restart-exceptions.html#syntax-handle}{\mathsf{handle}}~\href{../syntax/modules.html#syntax-exnidx}{\mathit{exnidx}}~\href{../syntax/instructions.html#syntax-instr}{\mathit{instr}}_2^\ast~\href{../syntax/instructions.html#syntax-instr-control}{\mathsf{end}}) \\
\hspace{9ex} \href{../exec/conventions.html#formal-notation}{\hookrightarrow}  S; F; \href{../appendix/restart-exceptions.html#syntax-handle}{\mathsf{handle}}_?\{ \href{../exec/runtime.html#syntax-exnaddr}{\mathit{exnaddr}}~\href{../syntax/instructions.html#syntax-instr}{\mathit{instr}}_2 \}~(\href{../exec/runtime.html#syntax-label}{\mathsf{label}}_m \{\}~\href{../exec/runtime.html#syntax-val}{\mathit{val}}^n~\href{../syntax/instructions.html#syntax-instr}{\mathit{instr}}_1^\ast~\href{../syntax/instructions.html#syntax-instr-control}{\mathsf{end}})~\href{../syntax/instructions.html#syntax-instr-control}{\mathsf{end}} \\
(\mathrel{\mbox{if}} \href{../exec/runtime.html#syntax-frame}{\mathrm{expand}}_F(\mathit{bt}) = [t_1^n] \href{../syntax/types.html#syntax-functype}{\rightarrow} [t_2^m] \wedge S.\href{../exec/runtime.html#syntax-store}{\mathsf{exceptions}}[\href{../syntax/modules.html#syntax-exnidx}{\mathit{exnidx}}] = \href{../exec/runtime.html#syntax-exnaddr}{\mathit{exnaddr}})\\
\end{array}\end{split}\]</div>
</div>
<div class="section" id="reduction-steps-for-handle">
<span id="exec-handle"></span><h3>Reduction steps for <span class="math notranslate nohighlight">\(\href{../appendix/restart-exceptions.html#syntax-handle}{\mathsf{handle}}\)</span><a class="headerlink" href="#reduction-steps-for-handle" title="Permalink to this headline">¶</a></h3>
<div class="math notranslate nohighlight">
\[\begin{array}{lcl&#64;{\qquad}l}
\href{../appendix/restart-exceptions.html#syntax-handle}{\mathsf{handle}}_?\{\href{../exec/runtime.html#syntax-exnaddr}{\mathit{exnaddr}}~instr^\ast\}~\href{../exec/runtime.html#syntax-val}{\mathit{val}}^m~\href{../syntax/instructions.html#syntax-instr-control}{\mathsf{end}} &amp;\href{../exec/conventions.html#formal-notation}{\hookrightarrow}&amp; \href{../exec/runtime.html#syntax-val}{\mathit{val}}^m
\end{array}\]</div>
<p>The next step which is checking for active handles should happen before the check for a catching <span class="math notranslate nohighlight">\(\href{../syntax/instructions.html#syntax-instr-control}{\mathsf{try}}\)</span> block
and before unwinding the stack, so right before step 5 in
<a class="reference internal" href="../exec/instructions.html#exec-throwaddr"><span class="std std-ref">the instructions for throwing an exception address</span></a>.</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{c}
   \hspace{-9ex} S; F; \href{../appendix/restart-exceptions.html#syntax-handle}{\mathsf{handle}}_?\{ \href{../exec/runtime.html#syntax-exnaddr}{\mathit{exnaddr}}~\href{../syntax/instructions.html#syntax-instr}{\mathit{instr}}^\ast \} T[\href{../exec/runtime.html#syntax-val}{\mathit{val}}^n~(\href{../exec/runtime.html#syntax-throwaddr}{\mathsf{throw}}~\href{../exec/runtime.html#syntax-exnaddr}{\mathit{exnaddr}})]~\href{../syntax/instructions.html#syntax-instr-control}{\mathsf{end}} \\
   \hspace{9ex} \href{../exec/conventions.html#formal-notation}{\hookrightarrow} S; F; \href{../appendix/restart-exceptions.html#syntax-handle}{\mathsf{handle}}_?\{ \href{../exec/runtime.html#syntax-exnaddr}{\mathit{exnaddr}}~\href{../syntax/instructions.html#syntax-instr}{\mathit{instr}}^\ast \} T[\href{../syntax/instructions.html#syntax-instr}{\mathit{instr}}^\ast]~\href{../syntax/instructions.html#syntax-instr-control}{\mathsf{end}}\\
   (\mathrel{\mbox{if}} \textrm{a handle for }\href{../exec/runtime.html#syntax-exnaddr}{\mathit{exnaddr}}\textrm{ is in the list of active handlers})\\
\end{array}\end{split}\]</div>
<p>Note that the step above does not remove the throw context T (unlike <span class="math notranslate nohighlight">\(\mathsf{catch}_m\)</span> which does),
so it’s not unwinding the stack.</p>
<p><em>(TODO: still need to formalise active handlers list: where and how they are stored.)</em></p>
</div>
</div>
<div class="section" id="examples">
<span id="id2"></span><h2>2. Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<div class="section" id="simoni-s-getval-examples">
<span id="simonis-getval-examples"></span><h3>Simoni’s <span class="math notranslate nohighlight">\(\mathsf{getVal}\)</span> examples<a class="headerlink" href="#simoni-s-getval-examples" title="Permalink to this headline">¶</a></h3>
<p>Here, Simoni’s examples appear rewritten in WebAssembly.
For a quick reference, Simoni’s <a class="reference internal" href="#simonis-examples-java"><span class="std std-ref">original examples</span></a>
are included in the end.</p>
<p>The first version of <span class="math notranslate nohighlight">\(\mathsf{getVal}\)</span> is without resumption capabilities, and can be
written in the current exception handling spec as the following <span class="math notranslate nohighlight">\(\mathsf{getval}\)</span>.</p>
<div class="highlight-pseudo notranslate"><div class="highlight"><pre><span></span>(module
  (type (<span class="k">func</span>))
  (exception $noval_exn (type <span class="nf">0</span>))
  (global $val (mut i32) (i32.const 0))
  (<span class="k">func</span> $getval (result i32)
    global.get 0
    try (params i32) (result i32)
      i32.eqz
      <span class="k">if</span> (type <span class="nf">0</span>)
        throw (exception $noval_exn)
      end
    catch
      <span class="k">return</span>
    end))
</pre></div>
</div>
<p>As Simoni notes, the stack before and after the throw will look as follows (the middle stack gets unwound).</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{r|c|}
  &amp; \vdots \\
  &amp; \textrm{outside stack} \\
  &amp; \vdots \\
  &amp; \href{../exec/runtime.html#syntax-catchn}{\mathsf{catch}}_1 \{\href{../syntax/instructions.html#syntax-instr-control}{\mathsf{return}}\}\\
  &amp; \href{../exec/runtime.html#syntax-label}{\mathsf{label}}_1 \{\} \\
  \textrm{middle stack }\rightarrow &amp; \href{../exec/runtime.html#syntax-label}{\mathsf{label}}_0 \{\} \\
  &amp; \href{../exec/runtime.html#syntax-throwaddr}{\mathsf{throw}}~a_\mathsf{noval\_exn} \\
\end{array}
\hspace{5ex} \href{../exec/conventions.html#formal-notation}{\hookrightarrow} \hspace{5ex}
\begin{array}{|c|}
  \vdots \\
  \textrm{outside stack} \\
  \vdots \\
  \href{../exec/runtime.html#syntax-label}{\mathsf{label}}_1 \{\} \\
  \href{../exec/runtime.html#syntax-refexnaddr}{\mathsf{ref{.}exn}}~a_\mathsf{noval\_exn} \\
  \href{../syntax/instructions.html#syntax-instr-control}{\mathsf{return}} \\
\end{array}\end{split}\]</div>
</div>
<div class="section" id="example-1-getval-with-one-restart">
<h3>Example 1: <span class="math notranslate nohighlight">\(\mathsf{getval}\)</span> with one restart<a class="headerlink" href="#example-1-getval-with-one-restart" title="Permalink to this headline">¶</a></h3>
<div class="highlight-pseudo notranslate"><div class="highlight"><pre><span></span>(module
  (type (<span class="k">func</span>))
  (exception $useval_restart (param i32))
  (exception $noval_exn (type <span class="nf">0</span>))
  (global $val (mut i32) (i32.const 0))
  (<span class="k">func</span> $getval1 (result i32)
    global.get 0
    try $default (params i32) (result i32)
      i32.eqz
      <span class="k">if</span> (type <span class="nf">0</span>)
        throw (exception $noval_exn)
      end
    catch
      br_on_exn $default (exception $useval_restart)
      rethrow
    end
    ;; code for the restart tagged $useval_restart goes here
    <span class="k">return</span>)
    ...
</pre></div>
</div>
<p>Simoni’s article says:</p>
<blockquote>
<div><p>GETVAL can be restarted by throwing a USEVALRESTART whose value will be returned by GETVAL.</p>
</div></blockquote>
<p>A user could now choose to provide a default value when <span class="math notranslate nohighlight">\(\mathsf{val}\)</span> is 0
by writing the following function, as in <a class="reference internal" href="#app-choosing-first-restart"><span class="std std-ref">Simoni’s app example</span></a>.</p>
<div class="highlight-pseudo notranslate"><div class="highlight"><pre><span></span>...
  (<span class="k">func</span> $app1 (export &quot;app_use_val_restart&quot;) (result i32)
    try (result i32)
      call $getval1
    handle $noval_exn
      i32.const 27 ;; &quot;the default value&quot;
      throw $use_val_restart
    end))
</pre></div>
</div>
<p>When we call <span class="math notranslate nohighlight">\(\mathsf{app}1\)</span> and the function <span class="math notranslate nohighlight">\(\mathsf{getval}\_1\)</span> is invoked
with the handle <span class="math notranslate nohighlight">\(\href{../appendix/restart-exceptions.html#syntax-handle}{\mathsf{handle}} \{ \mathsf{noval\_exn} (...) \}\)</span> activated (on the stack),
and the global with <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-globalidx}{\mathit{globalidx}}\)</span> 0 has value 0, the stack is the left one below.</p>
<p>Then the exception <span class="math notranslate nohighlight">\(\mathsf{noval\_exn}\)</span> is thrown, and because
<span class="math notranslate nohighlight">\(\href{../appendix/restart-exceptions.html#syntax-handle}{\mathsf{handle}} \{ \mathsf{noval\_exn} (...) \}\)</span> is active, its instructions (…) are put
on the stack <strong>after</strong> <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-throwaddr}{\mathsf{throw}}~\mathsf{noval\_exn}\)</span> (middle stack below).</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{r|c|}
  &amp;\vdots \\
  &amp;\textrm{outside stack} \\
  &amp;\vdots \\
  &amp;\href{../appendix/restart-exceptions.html#syntax-handle}{\mathsf{handle}}_? \{ \mathsf{noval\_exn} ~ (...) \} \\
  &amp; \href{../exec/runtime.html#syntax-label}{\mathsf{label}}_? \{\} \\
  \$\mathsf{getval}\textrm{ frame} &amp;     \href{../exec/runtime.html#syntax-frame}{\mathsf{frame}}_1\{F\} \\
  \$\mathsf{getval}\textrm{ frame label} &amp;    \href{../exec/runtime.html#syntax-label}{\mathsf{label}}_1 \{\} \\
  \textrm{[1]} &amp;     \href{../syntax/instructions.html#syntax-instr-control}{\mathsf{catch}}_1 \{ .... \}\\
  \textrm{middle stack} &amp;     \href{../exec/runtime.html#syntax-label}{\mathsf{label}}_1 \{\} \\
  \textrm{[A]} &amp;\href{../exec/runtime.html#syntax-throwaddr}{\mathsf{throw}}~a_\mathsf{noval\_exn} \\
\end{array}
\hspace{5ex} \href{../exec/conventions.html#formal-notation}{\hookrightarrow} \hspace{5ex}
\begin{array}{|c|l}
  \vdots &amp;\\
  \textrm{outside stack} &amp;\\
  \vdots &amp;\\
  \href{../appendix/restart-exceptions.html#syntax-handle}{\mathsf{handle}}_? \{ \mathsf{noval\_exn} ~ (...) \} &amp;\textrm{[B]}\\
  \href{../exec/runtime.html#syntax-label}{\mathsf{label}}_? \{\} &amp;\\
  \href{../exec/runtime.html#syntax-frame}{\mathsf{frame}}_1\{F\} &amp;\$\mathsf{getval}\textrm{ frame} \\
  \href{../exec/runtime.html#syntax-label}{\mathsf{label}}_1 \{\} &amp;\$\mathsf{getval}\textrm{ frame label} \\
  \href{../syntax/instructions.html#syntax-instr-control}{\mathsf{catch}}_1 \{ ....  \} &amp;\textrm{[1]}\\
  \href{../exec/runtime.html#syntax-label}{\mathsf{label}}_1 \{\} &amp;\textrm{middle stack} \\
  \textrm{;; handle [B] adds (...):} &amp;\\
  \mathsf{i32.const}~27 &amp;\\
  \href{../exec/runtime.html#syntax-throwaddr}{\mathsf{throw}}~a_\mathsf{use\_val\_restart} &amp;\textrm{[2]}\\
\end{array}\end{split}\]</div>
<p>As Simoni says</p>
<blockquote>
<div><p>The restart at [2] bubbles up, and is returned by the TRY/CATCH for the restart at [1], which means that GETVAL returns “the default value” [provided by the user in the app]:</p>
</div></blockquote>
<div class="math notranslate nohighlight">
\[\begin{split}\dots \hspace{5ex} \href{../exec/conventions.html#formal-notation}{\hookrightarrow} \hspace{5ex}
\begin{array}{|c|l}
  \vdots &amp;\\
  \textrm{outside stack} &amp;\\
  \vdots &amp;\\
  \href{../appendix/restart-exceptions.html#syntax-handle}{\mathsf{handle}}_? \{ \mathsf{noval\_exn} \dots \} &amp; \\
  \href{../exec/runtime.html#syntax-label}{\mathsf{label}}_? \{\}&amp; \\
  \href{../exec/runtime.html#syntax-frame}{\mathsf{frame}}_1\{F\} &amp;\$\mathsf{getval}\textrm{ frame} \\
  \href{../exec/runtime.html#syntax-label}{\mathsf{label}}_1 \{\} &amp;\$\mathsf{getval}\textrm{ frame label} \\
  \mathsf{i32.const}~27 &amp;\href{../syntax/instructions.html#syntax-instr-control}{\mathsf{br\_on\_exn}} \textrm{ returns the exception package values}\\
\end{array}\end{split}\]</div>
<p>Note that if <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-catchn}{\mathsf{catch}}\)</span> would take an exception index this would be much more complicated.</p>
</div>
<div class="section" id="example-2-the-function-getval-with-two-restarts">
<h3>Example 2: the function <span class="math notranslate nohighlight">\(\mathsf{getval}\)</span> with two restarts<a class="headerlink" href="#example-2-the-function-getval-with-two-restarts" title="Permalink to this headline">¶</a></h3>
<p>In this example <span class="math notranslate nohighlight">\(\mathsf{getval}\)</span> provides an alternative restart tagged <span class="math notranslate nohighlight">\(\mathsf{user\_choose\_restart}\)</span>
which prompts the user choose the value to use. For this, a js function <span class="math notranslate nohighlight">\(\mathsf{user_val_dialog}\)</span>
is imported.</p>
<div class="highlight-pseudo notranslate"><div class="highlight"><pre><span></span>(module
  (type (<span class="k">func</span>))
  (import &quot;js&quot; &quot;user_val_dialog&quot; (<span class="k">func</span> (result i32)))
  (exception $use_val_restart (param i32))
  (exception $user_choose_restart (type <span class="nf">0</span>))
  (exception $noval_exn (type <span class="nf">0</span>))
  (global $val (mut i32) (i32.const 0))
  (<span class="k">func</span> $getval2 (result i32)
    global.get 0
    block $userchoose
      try $default (params i32) (result i32)
        i32.eqz
        <span class="k">if</span> (type <span class="nf">0</span>)
          throw (exception $noval_exn)
        end
      catch
        br_on_exn $default (exception $use_val_restart)
        br_on_exn $userchoose (exception $user_choose_restart)
        rethrow
      end
      ;; code for the restart tagged $use_val_restart goes here
      <span class="k">return</span>
    end
    ;; code for the restart tagged $user_choose_restart goes here
    call $user_val_dialog)
 ...
</pre></div>
</div>
<p>A user could now choose to prompt the user for a value
by writing the following function, as in <a class="reference internal" href="#app-choosing-second-restart"><span class="std std-ref">Simoni’s second app example</span></a>.</p>
<div class="highlight-pseudo notranslate"><div class="highlight"><pre><span></span>...
  (<span class="k">func</span> $app1 (export &quot;app_user_choose_restart&quot;) (result i32)
    try (result i32)
      call $getval2
    handle $user_choose_restart
      throw $user_choose_restart
    end))
</pre></div>
</div>
<p><em>(TODO: add stack transformations)</em></p>
</div>
</div>
<div class="section" id="simoni-s-original-examples-in-java">
<span id="simonis-examples-java"></span><h2>Simoni’s original examples in Java<a class="headerlink" href="#simoni-s-original-examples-in-java" title="Permalink to this headline">¶</a></h2>
<div class="section" id="plain-mathsf-getval-without-restarts">
<span id="getval-plain"></span><h3>Plain <span class="math notranslate nohighlight">\(\mathsf{getVal} ()\)</span>, without restarts<a class="headerlink" href="#plain-mathsf-getval-without-restarts" title="Permalink to this headline">¶</a></h3>
<div class="highlight-pseudo notranslate"><div class="highlight"><pre><span></span>Object getVal() {
  <span class="k">if</span> (val == null) throw new NoValException();
  else <span class="k">return</span> val;
}
</pre></div>
</div>
</div>
<div class="section" id="the-function-mathsf-getval-with-one-restart">
<span id="getval-with-one-restart"></span><h3>The function <span class="math notranslate nohighlight">\(\mathsf{getVal} ()\)</span> with one restart<a class="headerlink" href="#the-function-mathsf-getval-with-one-restart" title="Permalink to this headline">¶</a></h3>
<p>This has one handler tagged <span class="math notranslate nohighlight">\(UseValRestart\)</span> installed, which provides
a restart for using a value from the originating (app) code.</p>
<div class="highlight-pseudo notranslate"><div class="highlight"><pre><span></span>Object getVal() {
  try {
    <span class="k">if</span> (val == null) throw new NoValException();
    else <span class="k">return</span> val;
  } catch (UseValRestart r) {
    <span class="k">return</span> r.getVal();
  }
}
</pre></div>
</div>
</div>
<div class="section" id="app-installing-the-mathsf-getval-handler-tagged-mathsf-usevalrestart">
<span id="app-choosing-first-restart"></span><h3>App installing the <span class="math notranslate nohighlight">\(\mathsf{getVal} ()\)</span> handler tagged <span class="math notranslate nohighlight">\(\mathsf{UseValRestart}\)</span><a class="headerlink" href="#app-installing-the-mathsf-getval-handler-tagged-mathsf-usevalrestart" title="Permalink to this headline">¶</a></h3>
<div class="highlight-pseudo notranslate"><div class="highlight"><pre><span></span>try {
  getVal();
} handle (NoValException e) {
  throw new UseValRestart(&quot;the default value&quot;);
}
</pre></div>
</div>
</div>
<div class="section" id="the-function-mathsf-getval-with-two-restarts">
<span id="getval-with-two-restarts"></span><h3>The function <span class="math notranslate nohighlight">\(\mathsf{getVal} ()\)</span> with two restarts<a class="headerlink" href="#the-function-mathsf-getval-with-two-restarts" title="Permalink to this headline">¶</a></h3>
<div class="highlight-pseudo notranslate"><div class="highlight"><pre><span></span>Object getVal() {
  try {
    <span class="k">if</span> (val == null) throw new NoValException();
    else <span class="k">return</span> val;
  } catch (UseValRestart r) {
    <span class="k">return</span> r.getVal();
  } catch (LetUserChooseValRestart r) {
    <span class="k">return</span> showValDialog();
  }
}
</pre></div>
</div>
</div>
<div class="section" id="app-installing-the-mathsf-getval-handler-tagged-mathsf-letuserchoosevalrestart">
<span id="app-choosing-second-restart"></span><h3>App installing the <span class="math notranslate nohighlight">\(\mathsf{getVal} ()\)</span> handler tagged <span class="math notranslate nohighlight">\(\mathsf{LetUserChooseValRestart}\)</span><a class="headerlink" href="#app-installing-the-mathsf-getval-handler-tagged-mathsf-letuserchoosevalrestart" title="Permalink to this headline">¶</a></h3>
<p>The app using the above <span class="math notranslate nohighlight">\(\mathsf{getVal}\)</span> and installing the second handler
tagged <span class="math notranslate nohighlight">\(\mathsf{LetUserChooseValRestart}\)</span>.</p>
<div class="highlight-pseudo notranslate"><div class="highlight"><pre><span></span>try {
  getVal();
} handle (NoValException e) {
  throw new LetUserChooseValRestart();
}
</pre></div>
</div>
<p class="rubric">Footnotes</p>
<dl class="footnote brackets">
<dt class="label" id="cite-simoni"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>Manuel Simoni. <a class="reference external" href="https://axisofeval.blogspot.com/2011/04/whats-condition-system-and-why-do-you.html">What’s a condition system and why do you want one?</a>.</p>
</dd>
</dl>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2017, WebAssembly Community Group.
      
    </div>

    

    
  </body>
</html>